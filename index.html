<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Medical - Monitor Pacien»õi Firebase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .firebase-config {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .firebase-config h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c5282;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5282;
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-firebase {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .doctor-info {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doctor-details h3 {
            color: #2c5282;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .logout-btn {
            background: #e53e3e;
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
        }

        .patients-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .patients-list h3 {
            color: #2c5282;
            margin-bottom: 25px;
            font-size: 1.5em;
            text-align: center;
        }

        .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .patient-item:hover {
            border-color: #2c5282;
            background: #f0f4f8;
            transform: translateY(-2px);
        }

        .patient-item.selected {
            border-color: #2c5282;
            background: #e6f3ff;
        }

        .patient-info {
            flex-grow: 1;
        }

        .patient-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .patient-details {
            color: #666;
            font-size: 0.95em;
        }

        .patient-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .alert-normal {
            background: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2);
        }

        .alert-warning {
            background: #ed8936;
            box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
            animation: pulse-warning 2s infinite;
        }

        .alert-critical {
            background: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.3);
            animation: pulse-critical 1s infinite;
        }

        .alert-offline {
            background: #a0aec0;
            box-shadow: 0 0 0 3px rgba(160, 174, 192, 0.2);
        }

        @keyframes pulse-warning {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 6px rgba(237, 137, 54, 0.4);
            }
        }

        @keyframes pulse-critical {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.3);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 0 8px rgba(229, 62, 62, 0.6);
            }
        }

        .patient-values {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: none;
        }

        .patient-values.active {
            display: block;
        }

        .patient-values h4 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .value-item {
            text-align: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .ecg-item {
            grid-column: span 2;
            text-align: left;
        }

        .ecg-container {
            background: #000;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            position: relative;
        }

        #ecg-canvas {
            width: 100%;
            height: 120px;
            display: block;
        }

        .ecg-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .ecg-bpm {
            font-weight: bold;
            font-size: 16px;
        }

        .ecg-rhythm {
            font-style: italic;
        }

        .value-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .value-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3748;
        }

        .value-status {
            font-size: 0.8em;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .status-normal { background: #c6f6d5; color: #22543d; }
        .status-warning { background: #feebc8; color: #c05621; }
        .status-critical { background: #fed7d7; color: #c53030; }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #fc8181;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #9ae6b4;
        }

        .info {
            background: #bee3f8;
            color: #2c5282;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #63b3ed;
        }

        .last-update {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-disconnected {
            background: #fed7d7;
            color: #c53030;
        }

        .firebase-logo {
            display: inline-block;
            margin-right: 10px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">üî• Conectare Firebase...</div>

    <div class="container">
        <div class="header">
            <h1>üî• Portal Medical Firebase</h1>
            <p>Monitor pacien»õi √Æn timp real cu Firebase</p>
        </div>

        <!-- Configurare Firebase -->
        <div id="firebase-config" class="firebase-config">
            <h3>üî• Configurare Firebase</h3>
            <p style="margin-bottom: 15px; color: #856404;">
                <strong>üìã Introdu datele din Firebase Console:</strong><br>
                Project Settings ‚Üí General ‚Üí Your apps ‚Üí Firebase SDK snippet ‚Üí Config
            </p>
            <input type="text" id="firebase-project" class="config-input" 
                   placeholder="Project ID (ex: medical-monitor-12345)" 
                   value="">
            <input type="text" id="firebase-api-key" class="config-input" 
                   placeholder="API Key (ex: AIzaSyC...)" 
                   value="">
            <input type="text" id="firebase-auth-domain" class="config-input" 
                   placeholder="Auth Domain (ex: medical-monitor-12345.firebaseapp.com)" 
                   value="">
            <input type="text" id="firebase-database-url" class="config-input" 
                   placeholder="Database URL (ex: https://medical-monitor-12345-default-rtdb.firebaseio.com/)" 
                   value="">
            <button class="btn btn-firebase" onclick="connectFirebase()">üî• ConecteazƒÉ la Firebase</button>
        </div>

        <!-- Mesaje -->
        <div id="messages"></div>

        <!-- Sec»õiunea de autentificare -->
        <div id="auth-section" class="auth-section">
            <div class="login-form">
                <h2><span class="firebase-logo">üî•</span>Autentificare Firebase</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-email">Email medicul:</label>
                        <input type="email" id="login-email" placeholder="doctor@spital.com" 
                               value="doctor@test.com" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">ParolƒÉ:</label>
                        <input type="password" id="login-password" placeholder="Parola ta" 
                               value="test123" required>
                    </div>
                    <button type="submit" class="btn btn-firebase">üî• Conectare Firebase</button>
                    
                    <div style="text-align: center; margin-top: 15px; font-size: 0.9em; color: #666;">
                        Nu ai cont? Contul va fi creat automat la prima conectare.
                    </div>
                </form>
            </div>
        </div>

        <!-- Dashboard pentru medici -->
        <div id="dashboard" class="dashboard">
            <!-- Informa»õii medic -->
            <div class="doctor-info">
                <div class="doctor-details">
                    <h3><span class="firebase-logo">üî•</span>Dr. <span id="doctor-name">Nume Doctor</span></h3>
                    <p><strong>Email:</strong> <span id="doctor-email">doctor@spital.ro</span></p>
                    <p><strong>Firebase UID:</strong> <span id="doctor-uid">-</span></p>
                </div>
                <button class="btn logout-btn" onclick="logout()">Deconectare</button>
            </div>

            <!-- Lista pacien»õilor -->
            <div class="patients-list">
                <h3>üìã Lista Pacien»õi (Firebase Real-time)</h3>
                
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.9em;">
                    <strong>üî• Firebase Status:</strong> <span id="firebase-status">Conectare...</span><br>
                    <strong>üì° Real-time updates:</strong> Datele se actualizeazƒÉ automat c√¢nd se modificƒÉ √Æn Firebase
                </div>
                
                <div id="patients-container">
                    <div class="info">
                        üî• Se conecteazƒÉ la Firebase Database pentru √ÆncƒÉrcarea pacien»õilor...
                    </div>
                </div>
            </div>

            <!-- Detalii pacient selectat -->
            <div id="patient-values" class="patient-values">
                <h4>üî• MƒÉsurƒÉtori Firebase pentru: <span id="selected-patient-name">-</span></h4>
                <div class="values-grid">
                    <div class="value-item">
                        <div class="value-label">TemperaturƒÉ</div>
                        <div class="value-number" id="temp-value">--¬∞C</div>
                        <div class="value-status status-normal" id="temp-status">-</div>
                    </div>
                    <div class="value-item">
                        <div class="value-label">Puls</div>
                        <div class="value-number" id="pulse-value">-- BPM</div>
                        <div class="value-status status-normal" id="pulse-status">-</div>
                    </div>
                    <div class="value-item">
                        <div class="value-label">Umiditate</div>
                        <div class="value-number" id="humidity-value">--%</div>
                        <div class="value-status status-normal" id="humidity-status">-</div>
                    </div>
                    <div class="value-item ecg-item">
                        <div class="value-label">ElectrocardiogramƒÉ (ECG) - Firebase Real-time</div>
                        <div class="ecg-container">
                            <canvas id="ecg-canvas" width="300" height="120"></canvas>
                            <div class="ecg-info">
                                <span class="ecg-bpm" id="ecg-bpm">75 BPM</span>
                                <span class="ecg-rhythm" id="ecg-rhythm">Conectare Firebase...</span>
                            </div>
                        </div>
                        <div class="value-status status-normal" id="ecg-status">Firebase sync</div>
                    </div>
                </div>
            </div>

            <div class="last-update">
                üî• Ultima actualizare Firebase: <span id="last-update">-</span>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration »ôi variabile globale
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let currentDoctor = null;
        let selectedPatientId = null;
        let ecgCanvas = null;
        let ecgCtx = null;
        let ecgAnimation = null;
        let patientListeners = []; // Pentru unsubscribe la listeners

        // Func»õie pentru afi»ôarea mesajelor
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Conectare la Firebase cu configura»õia utilizatorului
        async function connectFirebase() {
            const projectId = document.getElementById('firebase-project').value.trim();
            const apiKey = document.getElementById('firebase-api-key').value.trim();
            const authDomain = document.getElementById('firebase-auth-domain').value.trim();
            const databaseURL = document.getElementById('firebase-database-url').value.trim();
            
            if (!projectId || !apiKey) {
                showMessage('Te rog completeazƒÉ cel pu»õin Project ID »ôi API Key!', 'error');
                return;
            }
            
            try {
                // Configura»õia Firebase bazatƒÉ pe input-ul utilizatorului
                const firebaseConfig = {
                    apiKey: apiKey,
                    authDomain: authDomain || `${projectId}.firebaseapp.com`,
                    databaseURL: databaseURL || `https://${projectId}-default-rtdb.firebaseio.com/`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`,
                    messagingSenderId: "123456789",
                    appId: "1:123456789:web:abcdef123456"
                };

                // »òterge aplica»õia Firebase existentƒÉ dacƒÉ existƒÉ
                if (firebaseApp) {
                    firebaseApp.delete();
                }

                // Ini»õializeazƒÉ Firebase
                firebaseApp = firebase.initializeApp(firebaseConfig, 'medical-portal');
                firebaseAuth = firebase.auth(firebaseApp);
                firebaseDb = firebase.database(firebaseApp);
                
                // TesteazƒÉ conexiunea
                await firebaseDb.ref('.info/connected').once('value');
                
                // SalveazƒÉ configura»õia pentru utilizƒÉri viitoare
                localStorage.setItem('firebase_config', JSON.stringify(firebaseConfig));
                
                // ActualizeazƒÉ UI
                document.getElementById('connection-status').textContent = 'üî• Firebase conectat';
                document.getElementById('connection-status').className = 'connection-status status-connected';
                document.getElementById('firebase-config').style.display = 'none';
                document.getElementById('firebase-status').textContent = 'Conectat »ôi func»õional';
                
                showMessage('üî• Firebase conectat cu succes! Po»õi sƒÉ te autentifici acum.', 'success');
                
                // Ini»õializeazƒÉ datele demo √Æn Firebase dacƒÉ nu existƒÉ
                await initializeDemoData();
                
            } catch (error) {
                console.error('Eroare conectare Firebase:', error);
                showMessage(`‚ùå Eroare Firebase: ${error.message}`, 'error');
                
                document.getElementById('connection-status').textContent = '‚ùå Firebase deconectat';
                document.getElementById('connection-status').className = 'connection-status status-disconnected';
            }
        }

        // Ini»õializeazƒÉ date demo √Æn Firebase
        async function initializeDemoData() {
            try {
                // VerificƒÉ dacƒÉ existƒÉ deja pacien»õi √Æn Firebase
                const patientsSnapshot = await firebaseDb.ref('patients').once('value');
                
                if (!patientsSnapshot.exists()) {
                    console.log('Ini»õializare date demo √Æn Firebase...');
                    
                    // Pacien»õi demo
                    const demoPatients = {
                        '1': {
                            nume: 'Popescu',
                            prenume: 'Ion', 
                            email: 'ion.popescu@email.com',
                            diagnostic: 'Infec»õie respiratorie',
                            camera: '101',
                            id_medic: 'demo_doctor_uid'
                        },
                        '2': {
                            nume: 'Ionescu',
                            prenume: 'Maria',
                            email: 'maria.ionescu@email.com', 
                            diagnostic: 'Recuperare post-operatorie',
                            camera: '102',
                            id_medic: 'demo_doctor_uid'
                        },
                        '3': {
                            nume: 'Dumitrescu',
                            prenume: 'Gheorghe',
                            email: 'gheorghe.dumitrescu@email.com',
                            diagnostic: 'Fibrila»õie atrialƒÉ',
                            camera: '103',
                            id_medic: 'demo_doctor_uid'
                        },
                        '4': {
                            nume: 'Georgescu',
                            prenume: 'Ana',
                            email: 'ana.georgescu@email.com',
                            diagnostic: 'Hipotensiune arterialƒÉ', 
                            camera: '104',
                            id_medic: 'demo_doctor_uid'
                        }
                    };
                    
                    // SalveazƒÉ pacien»õii √Æn Firebase
                    await firebaseDb.ref('patients').set(demoPatients);
                    
                    // Ini»õializeazƒÉ mƒÉsurƒÉtori pentru fiecare pacient
                    for (let patientId = 1; patientId <= 4; patientId++) {
                        const initialMeasurements = generateSimulatedData(patientId);
                        await firebaseDb.ref(`measurements/${patientId}`).set({
                            ...initialMeasurements,
                            timestamp: new Date().toISOString(),
                            lastUpdate: Date.now()
                        });
                    }
                    
                    console.log('Date demo ini»õializate √Æn Firebase cu succes!');
                }
            } catch (error) {
                console.error('Eroare ini»õializare date demo:', error);
            }
        }

        // Autentificare cu Firebase Authentication
        async function handleLogin(event) {
            event.preventDefault();
            
            if (!firebaseAuth) {
                showMessage('Te rog conecteazƒÉ-te mai √Ænt√¢i la Firebase!', 'error');
                return;
            }
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                showMessage('üî• Se conecteazƒÉ la Firebase Authentication...', 'info');
                
                let userCredential;
                try {
                    // √éncearcƒÉ sƒÉ se autentifice
                    userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
                } catch (authError) {
                    if (authError.code === 'auth/user-not-found' || authError.code === 'auth/wrong-password') {
                        // DacƒÉ utilizatorul nu existƒÉ, √ÆncearcƒÉ sƒÉ-l creeze
                        showMessage('üî• Cont nou - se creeazƒÉ √Æn Firebase...', 'info');
                        userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                        
                        // ActualizeazƒÉ profilul cu numele
                        await userCredential.user.updateProfile({
                            displayName: `Dr. ${email.split('@')[0]}`
                        });
                        
                        showMessage('üî• Cont nou creat cu succes!', 'success');
                    } else {
                        throw authError;
                    }
                }
                
                const user = userCredential.user;
                
                // SalveazƒÉ informa»õiile doctorului
                currentDoctor = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || `Dr. ${email.split('@')[0]}`,
                    photoURL: user.photoURL
                };
                
                showMessage('üî• Autentificare Firebase reu»ôitƒÉ!', 'success');
                showDashboard();
                
            } catch (error) {
                console.error('Eroare autentificare Firebase:', error);
                let errorMessage = 'Eroare de autentificare Firebase.';
                
                switch (error.code) {
                    case 'auth/weak-password':
                        errorMessage = 'Parola trebuie sƒÉ aibƒÉ cel pu»õin 6 caractere.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email-ul este deja folosit de alt cont.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Format email invalid.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'Utilizatorul nu existƒÉ √Æn Firebase.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'ParolƒÉ incorectƒÉ.';
                        break;
                    default:
                        errorMessage += ` (${error.message})`;
                }
                
                showMessage(`‚ùå ${errorMessage}`, 'error');
            }
        }

        // Afi»ôeazƒÉ dashboard-ul
        async function showDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('firebase-config').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            // ActualizeazƒÉ informa»õiile doctorului
            document.getElementById('doctor-name').textContent = currentDoctor.displayName || 'Doctor Firebase';
            document.getElementById('doctor-email').textContent = currentDoctor.email;
            document.getElementById('doctor-uid').textContent = currentDoctor.uid.substring(0, 8) + '...';
            
            // √éncarcƒÉ pacien»õii »ôi porne»ôte monitorizarea
            await loadPatientsFromFirebase();
            initializeECG();
            startFirebaseMonitoring();
        }

        // √éncarcƒÉ pacien»õii din Firebase
        async function loadPatientsFromFirebase() {
            try {
                const patientsSnapshot = await firebaseDb.ref('patients').once('value');
                const patients = patientsSnapshot.val();
                
                if (patients) {
                    const patientsArray = Object.keys(patients).map(key => ({
                        id: key,
                        ...patients[key]
                    }));
                    
                    displayPatients(patientsArray);
                    showMessage(`üî• ${patientsArray.length} pacien»õi √ÆncƒÉrca»õi din Firebase`, 'success');
                } else {
                    document.getElementById('patients-container').innerHTML = `
                        <div class="info">
                            üî• Nu sunt pacien»õi √Æn Firebase Database. RuleazƒÉ din nou conectarea pentru a ini»õializa date demo.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Eroare √ÆncƒÉrcare pacien»õi Firebase:', error);
                showMessage('‚ùå Eroare la √ÆncƒÉrcarea pacien»õilor din Firebase', 'error');
            }
        }

        // Afi»ôeazƒÉ lista pacien»õilor
        function displayPatients(patients) {
            const container = document.getElementById('patients-container');
            
            if (!patients || patients.length === 0) {
                container.innerHTML = `
                    <div class="info">
                        üî• Nu sunt pacien»õi √Ænregistra»õi √Æn Firebase Database.
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            patients.forEach(patient => {
                const patientElement = document.createElement('div');
                patientElement.className = 'patient-item';
                patientElement.onclick = () => selectPatient(patient.id, `${patient.prenume} ${patient.nume}`);
                
                patientElement.innerHTML = `
                    <div class="patient-info">
                        <div class="patient-name">${patient.prenume} ${patient.nume}</div>
                        <div class="patient-details">
                            üìß ${patient.email} | 
                            üè• Camera ${patient.camera} | 
                            üìã ${patient.diagnostic}
                        </div>
                    </div>
                    <div class="patient-status">
                        <div class="alert-indicator alert-offline" id="alert-${patient.id}"></div>
                    </div>
                `;
                
                container.appendChild(patientElement);
            });
        }

        // SelecteazƒÉ un pacient
        function selectPatient(patientId, patientName) {
            console.log(`üî• Selectare pacient Firebase: ${patientId} - ${patientName}`);
            
            // EliminƒÉ selec»õia anterioarƒÉ
            document.querySelectorAll('.patient-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // SelecteazƒÉ pacientul curent
            event.target.closest('.patient-item').classList.add('selected');
            
            selectedPatientId = patientId;
            document.getElementById('selected-patient-name').textContent = patientName;
            document.getElementById('patient-values').classList.add('active');
            
            // Opre»ôte listener-ul anterior dacƒÉ existƒÉ
            if (selectedPatientId && patientListeners[selectedPatientId]) {
                patientListeners[selectedPatientId]();
            }
            
            // Porne»ôte real-time monitoring pentru pacientul selectat
            startPatientRealTimeMonitoring(patientId);
        }

        // Monitoring √Æn timp real pentru pacientul selectat
        function startPatientRealTimeMonitoring(patientId) {
            const measurementsRef = firebaseDb.ref(`measurements/${patientId}`);
            
            // Listener pentru mƒÉsurƒÉtori √Æn timp real
            const unsubscribe = measurementsRef.on('value', (snapshot) => {
                const measurements = snapshot.val();
                if (measurements) {
                    console.log(`üî• Update real-time pentru pacientul ${patientId}:`, measurements);
                    updateSelectedPatientValues(measurements);
                    updatePatientAlert(patientId, measurements);
                    
                    // ProceseazƒÉ date ECG √Æn timp real dacƒÉ existƒÉ
                    if (measurements.ecgRealTime) {
                        processRealTimeECG(measurements.ecgRealTime);
                    }
                }
            });
            
            // SalveazƒÉ unsubscribe function
            patientListeners[patientId] = unsubscribe;
        }

        // Porne»ôte monitorizarea Firebase pentru to»õi pacien»õii
        function startFirebaseMonitoring() {
            console.log('üî• Pornire monitoring Firebase...');
            
            // SimuleazƒÉ Arduino care trimite date √Æn Firebase la fiecare 5 secunde
            setInterval(async () => {
                try {
                    // GenereazƒÉ date noi pentru to»õi pacien»õii
                    for (let patientId = 1; patientId <= 4; patientId++) {
                        const newMeasurements = generateSimulatedData(patientId);
                        
                        // SalveazƒÉ √Æn Firebase - va declan»ôa automat listener-ii
                        await firebaseDb.ref(`measurements/${patientId}`).set({
                            ...newMeasurements,
                            timestamp: new Date().toISOString(),
                            lastUpdate: Date.now()
                        });
                    }
                    
                    // ActualizeazƒÉ timestamp-ul global
                    document.getElementById('last-update').textContent = new Date().toLocaleString('ro-RO');
                    
                } catch (error) {
                    console.error('üî• Eroare update Firebase:', error);
                }
            }, 5000); // La fiecare 5 secunde

            // Monitoring pentru status pacien»õi (alertele)
            setTimeout(() => {
                startPatientsStatusMonitoring();
            }, 1000);
        }

        // Monitoring status pentru to»õi pacien»õii (pentru alertele vizuale)
        function startPatientsStatusMonitoring() {
            const patientElements = document.querySelectorAll('.patient-item');
            
            patientElements.forEach(element => {
                const alertElement = element.querySelector('.alert-indicator');
                const patientId = alertElement.id.replace('alert-', '');
                
                // Listener pentru fiecare pacient
                const measurementsRef = firebaseDb.ref(`measurements/${patientId}`);
                measurementsRef.on('value', (snapshot) => {
                    const measurements = snapshot.val();
                    if (measurements) {
                        updatePatientAlert(patientId, measurements);
                    }
                });
            });
        }

        // ActualizeazƒÉ valorile pentru pacientul selectat
        function updateSelectedPatientValues(measurements) {
            document.getElementById('temp-value').textContent = `${measurements.temperatura}¬∞C`;
            document.getElementById('pulse-value').textContent = `${measurements.puls} BPM`;
            document.getElementById('humidity-value').textContent = `${measurements.umiditate}%`;

            // ActualizeazƒÉ statusurile
            const temp = parseFloat(measurements.temperatura);
            const puls = parseInt(measurements.puls);
            const ecgValue = parseFloat(measurements.ecg);

            updateValueStatus('temp', temp, [36.0, 37.5], [35.5, 38.5]);
            updateValueStatus('pulse', puls, [60, 100], [50, 120]);
            updateValueStatus('ecg', ecgValue, [0.3, 0.8], [0.2, 1.0]);
            
            // Umiditatea
            document.getElementById('humidity-status').textContent = 'Firebase sync';
            document.getElementById('humidity-status').className = 'value-status status-normal';
        }

        // ActualizeazƒÉ status pentru o valoare specificƒÉ
        function updateValueStatus(prefix, value, normalRange, criticalRange) {
            const statusElement = document.getElementById(`${prefix}-status`);
            
            if (value < criticalRange[0] || value > criticalRange[1]) {
                statusElement.textContent = 'CRITIC';
                statusElement.className = 'value-status status-critical';
            } else if (value < normalRange[0] || value > normalRange[1]) {
                statusElement.textContent = 'Aten»õie';
                statusElement.className = 'value-status status-warning';
            } else {
                statusElement.textContent = 'Normal';
                statusElement.className = 'value-status status-normal';
            }
        }

        // ActualizeazƒÉ alerta pentru un pacient
        function updatePatientAlert(patientId, measurements) {
            const alertElement = document.getElementById(`alert-${patientId}`);
            if (!alertElement) return;

            const temp = parseFloat(measurements.temperatura);
            const puls = parseInt(measurements.puls);
            const ecg = parseFloat(measurements.ecg);

            let alertType = 'normal';
            
            // Valori critice
            if (temp > 38.5 || temp < 35.5 || puls > 120 || puls < 50 || ecg > 1.0) {
                alertType = 'critical';
            }
            // Valori de aten»õionare
            else if (temp > 37.5 || temp < 36.0 || puls > 100 || puls < 60 || ecg > 0.8) {
                alertType = 'warning';
            }

            alertElement.className = `alert-indicator alert-${alertType}`;
        }

        // Generare date simulate pentru demonstra»õie Firebase
        function generateSimulatedData(patientId) {
            const patientProfiles = {
                1: { // Ion Popescu - Pacient cu febrƒÉ »ôi tahicardie
                    temp: { base: 38.2, variation: 0.4 },
                    puls: { base: 105, variation: 15 },
                    umiditate: { base: 45, variation: 5 },
                    ecg: { base: 0.7, variation: 0.2, anomaly: false }
                },
                2: { // Maria Ionescu - Pacient stabil
                    temp: { base: 36.4, variation: 0.2 },
                    puls: { base: 72, variation: 8 },
                    umiditate: { base: 50, variation: 3 },
                    ecg: { base: 0.5, variation: 0.1, anomaly: false }
                },
                3: { // Gheorghe Dumitrescu - Aritmie
                    temp: { base: 36.8, variation: 0.3 },
                    puls: { base: 95, variation: 25 },
                    umiditate: { base: 48, variation: 4 },
                    ecg: { base: 0.9, variation: 0.4, anomaly: true }
                },
                4: { // Ana Georgescu - Hipotensiune
                    temp: { base: 36.1, variation: 0.2 },
                    puls: { base: 55, variation: 8 },
                    umiditate: { base: 52, variation: 3 },
                    ecg: { base: 0.4, variation: 0.1, anomaly: false }
                }
            };

            const profile = patientProfiles[patientId] || patientProfiles[2];
            
            const temp = profile.temp.base + (Math.random() - 0.5) * profile.temp.variation;
            const puls = Math.round(profile.puls.base + (Math.random() - 0.5) * profile.puls.variation);
            const umiditate = profile.umiditate.base + (Math.random() - 0.5) * profile.umiditate.variation;
            const ecg = Math.max(0.1, profile.ecg.base + (Math.random() - 0.5) * profile.ecg.variation);
            
            // Varia»õie √Æn timp
            const timeVariation = Math.sin(Date.now() / 30000) * 0.1;
            
            // Puncte ECG pentru streaming
            const ecgPoints = [];
            for (let i = 0; i < 10; i++) {
                const point = ecg + (Math.random() - 0.5) * 0.3;
                ecgPoints.push(point);
            }
            
            return {
                temperatura: Math.max(35.0, Math.min(42.0, temp + timeVariation)).toFixed(1),
                puls: Math.max(30, Math.min(200, Math.round(puls + timeVariation * 5))),
                umiditate: Math.max(20, Math.min(80, umiditate + timeVariation * 2)).toFixed(1),
                ecg: Math.max(0.1, Math.min(2.0, ecg + timeVariation * 0.1)).toFixed(2),
                timestamp: new Date().toLocaleString('ro-RO'),
                ecgRealTime: {
                    rawData: ecgPoints,
                    heartRate: Math.round(puls + timeVariation * 5),
                    rhythm: profile.ecg.anomaly ? 'arrhythmia' : 'normal',
                    sampleRate: 100
                }
            };
        }

        // ECG Functions
        let ecgDataBuffer = [];
        let maxECGBufferSize = 500;
        let isReceivingRealECG = false;

        function initializeECG() {
            ecgCanvas = document.getElementById('ecg-canvas');
            if (!ecgCanvas) return;
            
            ecgCtx = ecgCanvas.getContext('2d');
            
            const rect = ecgCanvas.getBoundingClientRect();
            ecgCanvas.width = rect.width * 2;
            ecgCanvas.height = rect.height * 2;
            ecgCtx.scale(2, 2);
            
            startECGAnimation();
        }

        function processRealTimeECG(ecgDataFromFirebase) {
            try {
                if (Array.isArray(ecgDataFromFirebase.rawData)) {
                    addECGPointsToBuffer(ecgDataFromFirebase.rawData);
                    updateECGMetrics(ecgDataFromFirebase);
                    isReceivingRealECG = true;
                }
            } catch (error) {
                console.error('Eroare procesare ECG Firebase:', error);
                isReceivingRealECG = false;
            }
        }

        function addECGPointsToBuffer(newPoints) {
            ecgDataBuffer.push(...newPoints);
            if (ecgDataBuffer.length > maxECGBufferSize) {
                ecgDataBuffer = ecgDataBuffer.slice(-maxECGBufferSize);
            }
        }

        function updateECGMetrics(ecgData) {
            if (ecgData.heartRate) {
                document.getElementById('ecg-bpm').textContent = `${ecgData.heartRate} BPM`;
            }
            
            if (ecgData.rhythm) {
                const rhythmElement = document.getElementById('ecg-rhythm');
                rhythmElement.textContent = getECGRhythmText(ecgData.rhythm);
                rhythmElement.style.color = getECGRhythmColor(ecgData.rhythm);
            }
        }

        function getECGRhythmText(rhythm) {
            const rhythms = {
                'normal': 'Ritm sinusal normal',
                'arrhythmia': 'Aritmie detectatƒÉ',
                'tachycardia': 'Tahicardie',
                'bradycardia': 'Bradicardie'
            };
            return rhythms[rhythm] || 'Firebase sync...';
        }

        function getECGRhythmColor(rhythm) {
            const colors = {
                'normal': '#00ff00',
                'arrhythmia': '#ff4444',
                'tachycardia': '#ffaa00',
                'bradycardia': '#ffaa00'
            };
            return colors[rhythm] || '#ffffff';
        }

        function startECGAnimation() {
            const canvas = ecgCanvas;
            const ctx = ecgCtx;
            if (!canvas || !ctx) return;
            
            const width = canvas.width / 2;
            const height = canvas.height / 2;
            const centerY = height / 2;
            
            function animate() {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, width, height);
                
                drawECGGrid(ctx, width, height);
                
                if (isReceivingRealECG && ecgDataBuffer.length > 0) {
                    drawRealECGData(ctx, width, height, centerY);
                } else {
                    drawSimulatedECGData(ctx, width, height, centerY);
                }
                
                ecgAnimation = requestAnimationFrame(animate);
            }
            
            animate();
        }

        function drawRealECGData(ctx, width, height, centerY) {
            if (ecgDataBuffer.length < 2) return;
            
            const hasAnomaly = detectECGAnomalies();
            ctx.strokeStyle = hasAnomaly ? '#ff4444' : '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const pointsToShow = Math.min(ecgDataBuffer.length, width);
            const startIndex = Math.max(0, ecgDataBuffer.length - pointsToShow);
            
            for (let i = 0; i < pointsToShow; i++) {
                const dataIndex = startIndex + i;
                const amplitude = ecgDataBuffer[dataIndex];
                const normalizedAmplitude = Math.max(-1, Math.min(1, amplitude / 2));
                
                const x = (i / pointsToShow) * width;
                const y = centerY - (normalizedAmplitude * centerY * 0.8);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Sweep line
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.beginPath();
            const sweepX = (Date.now() / 50) % width;
            ctx.moveTo(sweepX, 0);
            ctx.lineTo(sweepX, height);
            ctx.stroke();
        }

        function drawSimulatedECGData(ctx, width, height, centerY) {
            const currentTime = Date.now() / 1000;
            const heartRate = getCurrentHeartRate();
            const hasAnomaly = isECGAnomalous();
            
            ctx.strokeStyle = hasAnomaly ? '#ff4444' : '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const samplesPerSecond = 50;
            const secondsVisible = 6;
            const totalSamples = samplesPerSecond * secondsVisible;
            
            for (let i = 0; i < totalSamples; i++) {
                const timeOffset = (i / samplesPerSecond) - secondsVisible;
                const sampleTime = currentTime + timeOffset;
                const amplitude = generateECGWave(sampleTime, heartRate, hasAnomaly);
                
                const x = (i / totalSamples) * width;
                const y = centerY - (amplitude * centerY * 0.8);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
        }

        function detectECGAnomalies() {
            if (ecgDataBuffer.length < 100) return false;
            
            const recentData = ecgDataBuffer.slice(-100);
            const mean = recentData.reduce((a, b) => a + b, 0) / recentData.length;
            const variance = recentData.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / recentData.length;
            const stdDev = Math.sqrt(variance);
            const extremeValues = recentData.filter(val => Math.abs(val - mean) > 3 * stdDev);
            
            return extremeValues.length > recentData.length * 0.05;
        }

        function generateECGWave(time, heartRate = 75, anomaly = false) {
            const beatInterval = 60 / heartRate;
            const beatPhase = (time % beatInterval) / beatInterval;
            
            let amplitude = 0;
            
            if (beatPhase < 0.1) {
                amplitude = 0.2 * Math.sin(beatPhase * 10 * Math.PI);
            } else if (beatPhase < 0.2) {
                amplitude = 0;
            } else if (beatPhase < 0.35) {
                const qrsPhase = (beatPhase - 0.2) / 0.15;
                if (qrsPhase < 0.3) {
                    amplitude = -0.3 * Math.sin(qrsPhase * 3.33 * Math.PI);
                } else if (qrsPhase < 0.7) {
                    amplitude = 1.5 * Math.sin((qrsPhase - 0.3) * 2.5 * Math.PI);
                } else {
                    amplitude = -0.4 * Math.sin((qrsPhase - 0.7) * 3.33 * Math.PI);
                }
            } else if (beatPhase < 0.5) {
                amplitude = 0;
            } else if (beatPhase < 0.7) {
                amplitude = 0.3 * Math.sin((beatPhase - 0.5) * 5 * Math.PI);
            } else {
                amplitude = 0;
            }
            
            if (anomaly) {
                amplitude += 0.2 * Math.sin(time * 20) * Math.random();
            }
            
            amplitude += (Math.random() - 0.5) * 0.05;
            
            return amplitude;
        }

        function drawECGGrid(ctx, width, height) {
            ctx.strokeStyle = '#004400';
            ctx.lineWidth = 0.5;
            
            const verticalSpacing = width / 30;
            for (let x = 0; x < width; x += verticalSpacing) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            const horizontalSpacing = height / 10;
            for (let y = 0; y < height; y += horizontalSpacing) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            ctx.strokeStyle = '#006600';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);
            ctx.stroke();
        }

        function getCurrentHeartRate() {
            if (selectedPatientId) {
                const pulseElement = document.getElementById('pulse-value');
                const pulseText = pulseElement.textContent;
                const pulse = parseInt(pulseText.replace(' BPM', ''));
                return isNaN(pulse) ? 75 : pulse;
            }
            return 75;
        }

        function isECGAnomalous() {
            if (selectedPatientId) {
                const statusElement = document.getElementById('ecg-status');
                return statusElement.className.includes('critical') || statusElement.className.includes('warning');
            }
            return false;
        }

        // Deconectare
        function logout() {
            if (firebaseAuth && firebaseAuth.currentUser) {
                firebaseAuth.signOut();
            }
            
            // Opre»ôte to»õi listeners
            Object.values(patientListeners).forEach(unsubscribe => unsubscribe());
            patientListeners = [];
            
            currentDoctor = null;
            selectedPatientId = null;
            
            if (ecgAnimation) {
                cancelAnimationFrame(ecgAnimation);
            }
            
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('patient-values').classList.remove('active');
            
            showMessage('üî• Deconectat din Firebase cu succes.', 'success');
        }

        // Ini»õializare la √ÆncƒÉrcarea paginii
        document.addEventListener('DOMContentLoaded', function() {
            // √éncearcƒÉ sƒÉ restaureze configura»õia Firebase
            const savedConfig = localStorage.getItem('firebase_config');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('firebase-project').value = config.projectId || '';
                    document.getElementById('firebase-api-key').value = config.apiKey || '';
                    document.getElementById('firebase-auth-domain').value = config.authDomain || '';
                    document.getElementById('firebase-database-url').value = config.databaseURL || '';
                    
                    // Auto-conectare la Firebase dacƒÉ configura»õia existƒÉ
                    setTimeout(() => {
                        connectFirebase();
                    }, 1000);
                } catch (error) {
                    console.log('Nu s-a putut restaura configura»õia Firebase');
                }
            }
        });
    </script>
</body>
</html>
